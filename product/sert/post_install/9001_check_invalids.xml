<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:ora="http://www.oracle.com/xml/ns/dbchangelog-ext"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd"
>
  <changeSet
    id="invalid_objects_check"
    author="jlyle"
    runOnChange="true"
    runAlways="true"
  >
    <preConditions onFail="MARK_RAN" onError="HALT">
      <sqlCheck expectedResult="1">
          select case when count(status) > 0 then 1 else 0 end as mycount from dba_objects where owner in ('SERT_CORE','SERT_PUB') and status = 'INVALID';
      </sqlCheck>
    </preConditions>
    <rollback></rollback>
    <ora:runOracleScript ownerName="jlyle" sourceType="STRING" objectType="SCRIPT" objectName="invalid_objects_check">
        <ora:source>
            set pagesize 50000
            prompt "********************************************************************************"
            prompt "** Invalid Objects"
            prompt "********************************************************************************"
            select /*ansiconsole*/
                    owner||'.'||object_name invalid_object
                  ,object_type
            from dba_objects
            where status = 'INVALID'
              and owner in ('SERT_CORE','SERT_PUB');

            prompt "********************************************************************************"
            prompt "** Object Errors"
            prompt "********************************************************************************"
            select /*ansiconsole*/
                owner||'.'||name invalid_object
                ,type
                ,sequence
                ,line
                ,position
                ,nvl(regexp_substr(regexp_replace(text, '^PL/SQL: '), '^(ORA|PLS|PLW)'), 'PLS') message_type
                ,regexp_replace(regexp_replace(text, '^PL/SQL: '), '(ORA|PLS|PLW)-[0-9]+: ') text
            from dba_errors
            where owner in ('SERT_CORE','SERT_PUB')
            order by owner, type, name, sequence;
        </ora:source>
    </ora:runOracleScript>
    <stop>*** ERROR Invalid objects exist in schema ***</stop>
  </changeSet>
</databaseChangeLog>
